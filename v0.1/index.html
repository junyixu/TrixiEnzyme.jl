<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Home · TrixiEnzyme.jl</title><meta name="title" content="Home · TrixiEnzyme.jl"/><meta property="og:title" content="Home · TrixiEnzyme.jl"/><meta property="twitter:title" content="Home · TrixiEnzyme.jl"/><meta name="description" content="Documentation for TrixiEnzyme.jl."/><meta property="og:description" content="Documentation for TrixiEnzyme.jl."/><meta property="twitter:description" content="Documentation for TrixiEnzyme.jl."/><script data-outdated-warner src="assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="assets/documenter.js"></script><script src="search_index.js"></script><script src="siteinfo.js"></script><script src="../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="index.html">TrixiEnzyme.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li class="is-active"><a class="tocitem" href="index.html">Home</a><ul class="internal"><li><a class="tocitem" href="#Getting-started"><span>Getting started</span></a></li><li><a class="tocitem" href="#Notes-about-Enzyme"><span>Notes about Enzyme</span></a></li><li><a class="tocitem" href="#Configuring-Batch-Size"><span>Configuring Batch Size</span></a></li></ul></li><li><a class="tocitem" href="api.html">API reference</a></li><li><a class="tocitem" href="examples.html">Examples</a></li><li><a class="tocitem" href="GSoC.html">GSoC</a></li><li><a class="tocitem" href="notes.html">Notes</a></li><li><a class="tocitem" href="Contact.html">Contact Developer</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href="index.html">Home</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href="index.html">Home</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/junyixu/TrixiEnzyme.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/junyixu/TrixiEnzyme.jl/blob/main/docs/src/index.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="TrixiEnzyme"><a class="docs-heading-anchor" href="#TrixiEnzyme">TrixiEnzyme</a><a id="TrixiEnzyme-1"></a><a class="docs-heading-anchor-permalink" href="#TrixiEnzyme" title="Permalink"></a></h1><h2 id="Getting-started"><a class="docs-heading-anchor" href="#Getting-started">Getting started</a><a id="Getting-started-1"></a><a class="docs-heading-anchor-permalink" href="#Getting-started" title="Permalink"></a></h2><p><a href="https://en.wikipedia.org/wiki/Automatic_differentiation">Wikipedia&#39;s automatic differentiation entry</a> is a useful resource for learning about the advantages of AD techniques over other common differentiation methods (such as finite differencing).</p><p>TrixiEnzyme is not a registered Julia package, and it can be installed by running:</p><pre><code class="nohighlight hljs">] add https://github.com/junyixu/TrixiEnzyme.jl.git</code></pre><h2 id="Notes-about-Enzyme"><a class="docs-heading-anchor" href="#Notes-about-Enzyme">Notes about Enzyme</a><a id="Notes-about-Enzyme-1"></a><a class="docs-heading-anchor-permalink" href="#Notes-about-Enzyme" title="Permalink"></a></h2><p>Allocations of temporary arrays like these puts more pressure on the GC and impacts performance. That&#39;s why we have decided to pre-allocate them in <code>create_cache</code> - which is called when the semidiscretization <code>semi</code> is constructed. This is why we need Enzyme.jl, which supports mutating operations.</p><p>There&#39;s still some <a href="https://github.com/EnzymeAD/Enzyme.jl/issues/1661">caveats</a>  to <code>make_zero!</code> since it&#39;s brand new so there&#39;s some edge cases on a few structures, but those will get worked out and this flow should be the recommended path. One needs to be careful with a vanilla closure outside Enzyme. If one writes to caches and expect to differentiate through them, then the closure should be duplicated for handling the derivative of those values. If you want to track derivatives through arrays that are enclosed, you have to duplicate the array to have shadow memory for its differentiation. if you want to track derivatives through arrays that are enclosed, you have to duplicate the array to have shadow memory for its differentiation So if you only have the original memory, you cannot do the differentiation since you don&#39;t have a place to store the extra values. In a simplified sense, a <code>Dual{Float64}</code> is 128 bits, <code>Float64</code> is 64 bits, so if you&#39;re writing to a buffer of 5 <code>Float64</code> numbers, you need 5<em>2</em>64 bits of space to keep a dual number, which you don&#39;t have. So the best thing to do for a user would be to separate out the things that you need to track through, make them arguments to <a href="https://junyixu.github.io/TrixiEnzyme.jl/dev/api.html#TrixiEnzyme.enzyme_rhs!">the function</a>, and then simply Duplicate on those. This is how <a href="https://junyixu.github.io/TrixiEnzyme.jl/dev/api.html#TrixiEnzyme.jacobian_enzyme_forward"><code>TrixiEnzyme.jacobian_enzyme_forward</code></a> works: Extract the arguments from <code>semi.cache</code> and duplicate them to store shadows.</p><h2 id="Configuring-Batch-Size"><a class="docs-heading-anchor" href="#Configuring-Batch-Size">Configuring Batch Size</a><a id="Configuring-Batch-Size-1"></a><a class="docs-heading-anchor-permalink" href="#Configuring-Batch-Size" title="Permalink"></a></h2><p>To utilize <a href="https://enzymead.github.io/Enzyme.jl/stable/api/#EnzymeCore.BatchDuplicated"><code>Enzyme.BatchDuplicated(x, ∂f_∂xs)</code></a> or <a href="https://enzymead.github.io/Enzyme.jl/stable/api/#EnzymeCore.BatchDuplicatedNoNeed"><code>Enzyme.BatchDuplicatedNoNeed(x, ∂f_∂xs)</code></a>, one can create a tuple containing duals (or shadows). TrixiEnzyme.jl performs partial derivative evaluation on one &quot;batch&quot; of the input vector at a time. Each differentiation of a batch requires a call to the target function as well as additional memory proportional to the square of the batch&#39;s size. Thus, a smaller batch size makes better use of memory bandwidth at the cost of more calls to the target function, while a larger batch size reduces calls to the target function at the cost of more memory bandwidth.</p><pre><code class="language-julia-repl hljs">julia&gt; x = -1:0.5:1;
julia&gt; batch_size = 2
julia&gt; @time jacobian_enzyme_forward(TrixiEnzyme.upwind!, x, N=batch_size)
  0.000040 seconds (31 allocations: 1.547 KiB)
5×5 Matrix{Float64}:
 -0.2  -0.0  -0.0  -0.0   0.2
  0.2  -0.2  -0.0  -0.0  -0.0
 -0.0   0.2  -0.2  -0.0  -0.0
 -0.0  -0.0   0.2  -0.2  -0.0
 -0.0  -0.0  -0.0   0.2  -0.2

julia&gt; x = -1:0.01:1;
julia&gt; @time jacobian_enzyme_forward(TrixiEnzyme.upwind!, x, N=2);
  0.000539 seconds (1.34 k allocations: 390.969 KiB)
julia&gt; @time jacobian_enzyme_forward(TrixiEnzyme.upwind!, x, N=11);
  0.000332 seconds (307 allocations: 410.453 KiB)</code></pre><p>When the cache is relatively small and you have appropriately chosen the batch size, Enzyme generally performs faster than ForwardDiff (see <a href="https://github.com/junyixu/TrixiEnzyme.jl/blob/main/test/UpwindTest.jl">test</a>). <img src="img/enzyme_ForwardDiff.png" alt="enzyme ForwardDiff upwind"/></p><p>If you do not explicitly provide a batch size, TrixiEnzyme will try to guess one for you based on your input vector:</p><pre><code class="language-julia-repl hljs">julia&gt; x = -1:0.01:1;
julia&gt; @time jacobian_enzyme_forward(TrixiEnzyme.upwind!, x);
  0.000327 seconds (307 allocations: 410.453 KiB)</code></pre><p>Benchmark for a 401x401 Jacobian of <code>TrixiEnzyme.upwind!</code> (Lower is better): <img src="img/upwind_benchmark.png" alt="upwind benchmark"/> <code>Enyme(@batch)</code> means applying <code>Polyester.@batch</code> to <code>middlebatches</code>.</p></article><nav class="docs-footer"><a class="docs-footer-nextpage" href="api.html">API reference »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.6.0 on <span class="colophon-date" title="Monday 26 August 2024 16:28">Monday 26 August 2024</span>. Using Julia version 1.10.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
